#!/bin/sh

INTERFACE="default"
CFG_FILE="/etc/moca/moca.conf.${INTERFACE}"
MOCACTL="/bin/mocactl"
MOCAD="/bin/mocad"

#
# MAIN
#

CFG_OPTS=""
[ -e $CFG_FILE ] && source $CFG_FILE

cmd="$1"
shift

if [ ! -e $MOCACTL ]; then
	echo "$0: MoCA utilities are not installed"
	exit 1
fi

case "$cmd" in
	set)
		echo "CFG_OPTS=\"$@\"" > $CFG_FILE
		sync
		exit 0
		;;
	
	show)
		echo "$CFG_OPTS"
		exit 0
		;;
	
	boot)
		echo "Starting mocad"
		$MOCAD -wD
		$MOCACTL restore_defaults
		$MOCACTL trace --none
		exec $MOCACTL start $CFG_OPTS
		exit 1
		;;

	kill)
		killall mocad >& /dev/null
		sleep 1
		exit 0
		;;

	start)
		$MOCACTL restore_defaults
		$MOCACTL trace --none
		exec $MOCACTL start $CFG_OPTS
		exit 1
		;;
	
	restart)
		$MOCACTL stop
		$MOCACTL restore_defaults
		$MOCACTL trace --none
		exec $MOCACTL start $CFG_OPTS
		exit 1
		;;
	
	stop)
		exec $MOCACTL stop
		exit 1
		;;
esac

echo "usage:"
echo "  mocacfg set [ <options> ]"
echo "  mocacfg show"
echo "  mocacfg { start | restart | stop }"
echo "  mocacfg { boot | kill }"

exit 1
